<div class="bookings-page">
  <div class="container-fluid withnav">
    <!--  Remove bookings-page class -->
    <div class="row">
      <nav>
        <div class="col-lg-4 pull-right">
          <div class="datepicker-wrap">
            <h4 class="text-center">Select the start date, and the end date:</h4>
            <span-select highlight-days="disp.highlightDays" first-date="filter.startDate" last-date="filter.endDate" month-changed="monthChanged">
            </span-select>
          </div>

        </div>
        <div class="col-lg-8 pull-left">
          <h1>Bookings</h1>
          <label>
            Filter by Route:
            <select ng-options="route.id as (route.label + ': ' + route.name) for route in disp.availableRoutes | orderBy:'label'" ng-model="filter.routeId" ng-required="false" class="form-control">
              <option value="">(All)</option>
            </select>
          </label>
          <br clear="both" />
          <div class="form-group pull-left ticketSearch">
            <label>
              Search by Trip ID
              <input type="number" ng-model="filter.tripId" ng-model-options="{ updateOn: 'blur' }" class="form-control" />
            </label>
          </div>
          <!-- stop query -->
          <div class="form-group pull-left ticketSearch">
            <label>
              Search by Stop ID
              <input type="text" ng-model="filter.stopQuery" ng-model-options="{ updateOn: 'blur' }" class="form-control" />
            </label>
          </div>
          <!-- user query -->
          <div class="form-group pull-left ticketSearch">
            <label>
              Search by User
              <input type="text" ng-model="filter.userQuery" ng-model-options="{ updateOn: 'blur' }" class="form-control" />
            </label>
          </div>
          <br clear="both">
          <div class="pull-left">
            <span class="ticketCheckbox">Ticket Status:</span>
            <label class="ticketCheckbox">
              <input type="checkbox" ng-model="filter.status.valid" /> Valid
            </label>

            <label class="ticketCheckbox">
              <input type="checkbox" ng-model="filter.status.refunded" /> Refunded
            </label>

            <label class="ticketCheckbox red-text">
              <input type="checkbox" ng-model="filter.status.void" /> Void
            </label>

            <label class="ticketCheckbox">
              <input type="checkbox" ng-model="filter.status.failed" /> Failed
            </label>

            <br clear="both">
            <button class="btn btn-primary bookingNav" ng-click="downloadCsv()">
              <span class="glyphicon glyphicon-save" aria-hidden="true"></span> Download CSV
            </button>

          </div>
        </div>
      </nav>
    </div>

    <div class="row">
      <div class="col-lg-12">
        <uib-pagination boundary-links="true" ng-model="currentPage" total-items="pageCount * perPage" items-per-page="perPage"></uib-pagination>
        <div class="red-text">
          Showing {{disp.pagination.firstRow}} to {{disp.pagination.lastRow}}  of {{disp.pagination.totalRows}}
        </div>
      </div>
    </div>
    <!-- <div>
    <span class="btn-group">
      <button class="btn btn-default"
        ng-click="showRefundModal()"
      >
        Refund...
      </button>
    </span>
</div> -->
    <div class="row">
      <div class="col-lg-12">
        <div class="table-responsive">
          <table class="table table-striped table-bordered table-condensed table-hover transactions-view">
            <thead>
              <tr>
                <th sort-direction='filter.order' sort-model="filter.orderBy" my-sort=""></th>
                <th sort-direction='filter.order' sort-model="filter.orderBy" my-sort="">Txn ID</th>
                <th sort-direction='filter.order' sort-model="filter.orderBy" my-sort="">Charge ID</th>
                <th sort-direction='filter.order' sort-model="filter.orderBy" my-sort="">User</th>
                <th sort-direction='filter.order' sort-model="filter.orderBy" my-sort="">Ticket<br>ID</th>
                <th sort-direction='filter.order' sort-model="filter.orderBy" my-sort="">Trip<br>ID</th>
                <th sort-direction='filter.order' sort-model="filter.orderBy" my-sort="boardingTime">Trip<br>Date</th>
                <th sort-direction='filter.order' sort-model="filter.orderBy" my-sort="route">Route<br>ID</th>
                <th sort-direction='filter.order' sort-model="filter.orderBy" my-sort="">Route<br>Label</th>
                <th sort-direction='filter.order' sort-model="filter.orderBy" my-sort="">Route<br>Description</th>
                <th sort-direction='filter.order' sort-model="filter.orderBy" my-sort="">Pick-up stop<br />Drop-off Stop</th>
                <th sort-direction='filter.order' sort-model="filter.orderBy" my-sort="">Price<br>per trip</th>
                <th sort-direction='filter.order' sort-model="filter.orderBy" my-sort="">Ticket<br>Status</th>
                <th sort-direction='filter.order' sort-model="filter.orderBy" my-sort="createdAt">Transaction<br>Timestamp</th>
                <th sort-direction='filter.order' sort-model="filter.orderBy" my-sort="">Ticket<br>Actions</th>
              </tr>
            </thead>

            <tbody>
              <tr ng-repeat="ticket in tickets" ng-class="{
            valid: ticket.status == 'valid',
            refunded: ticket.status == 'refunded',
            failed: ticket.status == 'failed',
              }">
              <td>
              <!-- <input type="checkbox" ng-model="selectedTickets[ticket.id]" style="height: 100%;" /> -->
              {{$index + 1}}
                </td>
                <td>
                  <a ui-sref="transactions({id: ticket.ticketSale.transactionId})">
                  {{ticket.ticketSale.transactionId}}
                </a>
                </td>
                <td class="item-description">
                  {{ticket.paymentResource}}
                  <span ng-if="ticket.refundResource"><br/>{{ticket.refundResource}}</span>
                  <span ng-if="ticket.paymentData.transfer.destination_payment">
                  <br/>{{ticket.paymentData.transfer.destination_payment}}
                </span>
                  <span ng-if="ticket.refundData.transfer.destination_payment">
                  <br/>{{ticket.refundData.transfer.destination_payment}}
                </span>
                <button class="btn btn-danger actions" ng-click="refund(ticket)" ng-if="ticket.status == 'valid' && ticket.paymentResource">
                   <span class="glyphicon glyphicon-credit-card" aria-hidden="true"></span> Refund
                </button>
                </td>
                <td>
                  <strong>{{ticket.user.json.name ? (ticket.user.json.name + ' #' + ticket.user.json.index) : ticket.user.name}} </strong>
                  <br> (UID: {{ticket.user.id}})
                  <br> {{ticket.user.json.telephone || ticket.user.telephone}}
                  <br> {{ticket.user.json.email || ticket.user.email}}
                </td>
                <td class="text-center">
                  <a ui-sref="transactions({ticketId: ticket.id})">
                    {{ticket.id}}
                  </a>
                  <br>
                  <button class="btn btn-default btn-icon" ng-click="sendWrsEmail(ticket.ticketSale.transactionId)">
                    <i class="glyphicon glyphicon-envelope"></i>
                  </button>
                </td>
                <td>
                  {{ticket.boardStop.trip.id}}
                </td>
                <td>
                  {{ticket.boardStop.trip.date | date:'dd-MMM-yy':'UTC'}}
                </td>
                <td>
                  {{ticket.boardStop.trip.routeId}}
                </td>
                <td>
                  {{ticket.boardStop.trip.route.label}}
                </td>
                <td class="item-description">
                  {{ticket.boardStop.trip.route.from}} <br /> {{ticket.boardStop.trip.route.to}}
                </td>
                <td class="item-description">
                  <table class="borderless">
                    <tr>
                      <td>
                        {{ticket.boardStop.time | date:'HH:mm'}}
                      </td>
                      <td>
                        {{ticket.boardStop.stop.description}}
                      </td>
                    </tr>
                    <tr>
                      <td>
                        {{ticket.alightStop.time | date:'HH:mm'}}
                      </td>
                      <td>
                        {{ticket.alightStop.stop.description}}
                      </td>
                    </tr>
                  </table>
                </td>
                <td>
                  &dollar;{{ticket.boardStop.trip.price}}
                </td>
                <td>
                  {{ticket.status}}
                </td>
                <td>
                  {{ticket.createdAt | date:'dd-MMM-yy'}} <br>
                  {{ticket.createdAt | date:'HH:mm:ss'}}
                </td>
                <td class="item-info text-center">
                  <div class="btn-group" role="group" aria-label="...">
                      <button type="button" class="btn btn-default" ng-click="" ng-disabled="ticket.status != 'valid'">
                        <span class="glyphicon glyphicon-plus-sign" aria-hidden="true"></span>
                        Add
                      </button>
                      <button type="button" class="btn btn-default" ng-click="replace(ticket)" ng-disabled="ticket.status != 'valid'">
                        <span class="glyphicon glyphicon-edit" aria-hidden="true"></span>
                        Edit
                      </button>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div> <!-- table-responsive -->
      </div> <!-- col-lg-12 -->
    </div> <!-- row -->
  </div> <!-- container-fluid -->
</div> <!-- .booking-page -->
