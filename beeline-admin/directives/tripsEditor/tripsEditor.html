
<section class="filter">
  <label>
    Start Date:
    <button class="glyphicon glyphicon-calendar"
      ng-click="filter.$startDatePopupIsOpen = !filter.$startDatePopupIsOpen">
    </button>
    <input type="text" uib-datepicker-popup="dd-MMM-yyyy"
      ng-model="filter.startDate"
      is-open="filter.$startDatePopupIsOpen">
  </label>
  <label ng-if="false">
    End Date:
    <button class="glyphicon glyphicon-calendar"
      ng-click="filter.$startDatePopupIsOpen = !filter.$startDatePopupIsOpen">
    </button>
    <input type="text" uib-datepicker-popup="dd-MMM-yyyy"
      ng-model="filter.endDate">
  </label>
</section>

<section class="add-trips">
  <h2>Add Trips</h2>
  <div class="add-trips-components flex-row">
    <beeline-datepicker
      ng-if="!disp.trip.id"
      class="flex-shrink"
      dates="disp.newDates"
      booked-dates="disp.existingDates"
      valid-dates="disp.validDates"
      show-legend="false"
      start-date="filter.startDate"
    >
    </beeline-datepicker>
    <div class="flex-shrink overflow-scroll selected-dates"
      ng-if="!disp.trip.id"
    >
      <h3>{{disp.newDates.length}} dates selected</h3>
      <ul>
        <li ng-repeat="date in disp.newDates | orderBy:date.getTime() track by $index">
          {{date | date:'dd-MMM-yy (EEE)':'UTC'}}
        </li>
      </ul>
    </div>

    <div class="flex-grow overflow-scroll">
      <h3 ng-if="!disp.trip.id">Stops</h3>
      <!-- <h3 ng-if="disp.trip">Editing trip on {{disp.trip.date | date:'dd-MMM-yy':'UTC'}}</h3> -->

      <h3 ng-if="disp.trip.id">Editing trip on
        <ng-repeat ng-repeat="(key, value) in selection.selected">
          {{value.date | date:'dd MMM yy'}},
        </ng-repeat>
      </h3>

      <label>
        Telephone number of driver: +65 <input type="tel" ng-model="disp.trip.driverTelephone" />

        <span ng-if="disp.trip.driverName">
          ~{{disp.driver.name}}
        </span>
      </label>

      <label>
        Trip capacity: <input type="number" ng-model="disp.trip.capacity" />
      </label>

      <label ng-if="adminService.session().role == 'superadmin'">
        Company:
        <company-selector ng-model="disp.trip.transportCompanyId">
        </company-selector>
      </label>

      <table>
        <thead>
          <tr>
            <th>Time</th>
            <th>Stop</th>
          </tr>
        </thead>
        <tbody>
          <tr ng-repeat="tripStop in disp.tripStops">
            <td>
              <uib-timepicker ng-model="tripStop.time"
              show-spinners="false" show-meridian="false">
            </td>
            <td>
              <!-- <input type="text" ng-model="tripStop.stopId"> -->
              <stop-selector
                ng-model="tripStop.stopId"
              ></stop-selector>
              <button ng-click="showPopupFor(tripStop)">
                ?
              </button>
            </td>
            <td>
              <label>
                <input type="checkbox" ng-model="tripStop.canBoard" />
                Boarding
              </label>
            </td>
            <td>
              <label>
                <input type="checkbox" ng-model="tripStop.canAlight" />
                Alighting
              </label>
            </td>
            <td>
              <button class="btn btn-default glyphicon glyphicon-trash"
                ng-click="disp.deleteTripStop($index)"
              ></button>
            </td>
          </tr>
        </tbody>
        <tfoot>
          <tr>
            <td>
              <button class="btn btn-default glyphicon glyphicon-plus"
                ng-click="disp.addTripStop()"
              ></button>
            </td>
          </tr>
        </tfoot>
      </table>
    </div>
  </div>

  <span class="btn-group">
    <button class="btn btn-primary" ng-click="saveTrips()"
      >
      Save
    </button>
    <button class="btn btn-default" ng-click="clearEdit()"
      ng-if="disp.trip">
      Clear
    </button>
  </span>
</section>

<div>
  <table class="table table-striped">
    <thead>
      <tr>
        <th></th> <!-- selection button -->
        <th></th> <!-- actions (delete, use) -->
        <th></th> <!-- pax -->
        <th></th> <!--date -->
        <th></th> <!-- driver -->
        <th colspan="{{disp.stopsList.length}}">Stops</th>
      </tr>
      <tr>
        <th></th>
        <th></th>
        <th>Cap</th>
        <th>Date</th>
        <th>Driver</th>
        <th ng-repeat="stop in disp.stopsList track by $index">
          {{stop.stop.label}} /
          {{stop.stop.postcode}}
        </th>
      </tr>
    </thead>
    <tbody>
      <tr ng-repeat="trip in (sorted_trips = trips | orderBy:'date') track by trip.id"
        class="{
          active: selection.selected[trip.id]
        }"
      >
        <td
          ng-mousedown="selectTrips(sorted_trips, $index, $event)"
          >
          <small>{{trip.id}}</small>
          <i ng-hide="!selection.selected[trip.id]"
            class="glyphicon glyphicon-ok">
          </i>
        </td>
        <td>
          <span class="btn-group">
            <button class="btn btn-default glyphicon glyphicon-copy"
              ng-click='referenceTrip(trip)'
            >
            </button>
            <button class="btn btn-default glyphicon glyphicon-trash"
              ng-click='deleteTrip(trip)'
            >
            </button>
          </span>
        </td>
        <td>
          {{trip.capacity}}
          <i class="glyphicon glyphicon-user"></i>
        </td>
        <td>
          {{trip.date | date:'dd/MM/yy EEE'}}
        </td>
        <td>
          {{trip.driverTelephone }}
        </td>
        <td ng-repeat="stop in disp.stopsList">
          {{ findStop(trip, stop.stop.id).time | date:'HH:mm'}}
        </td>
      </tr>
    </tbody>
  </table>
</div>
