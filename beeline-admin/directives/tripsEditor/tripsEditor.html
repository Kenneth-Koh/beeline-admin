
<section class="container-fluid">
  <div class="flex-row">
    <div class="flex-shrink" ng-style="{
      visibility: disp.trip.id ? 'hidden' : 'normal'
    }">
      <h3>New Trips</h3>
      <label>
        Start Date:
        <button class="glyphicon glyphicon-calendar"
          ng-click="filter.$startDatePopupIsOpen = !filter.$startDatePopupIsOpen">
        </button>
        <input type="text" uib-datepicker-popup="dd-MMM-yyyy"
          ng-model="filter.startDate"
          is-open="filter.$startDatePopupIsOpen">
      </label>
      <label ng-if="false">
        End Date:
        <button class="glyphicon glyphicon-calendar"
          ng-click="filter.$startDatePopupIsOpen = !filter.$startDatePopupIsOpen">
        </button>
        <input type="text" uib-datepicker-popup="dd-MMM-yyyy"
          ng-model="filter.endDate">
      </label>

      <beeline-datepicker
        dates="disp.newDates"
        booked-dates="disp.existingDates"
        valid-dates="disp.validDates"
        show-legend="false"
        start-date="filter.startDate">
      </beeline-datepicker>
    </div>

    <div class="flex-shrink overflow-scroll"
      ng-if="!disp.trip.id">
      <h3>{{disp.newDates.length}} dates selected</h3>
      <ul>
        <li ng-repeat="date in disp.newDates | orderBy:date.getTime() track by $index">
          {{date | date:'dd-MMM-yy (EEE)':'UTC'}}
        </li>
      </ul>
    </div>

    <div class="flex-shrink overflow-scroll"
      ng-if="disp.trip.id">
      <h3>{{disp.newDates.length}} dates selected</h3>
      <ul>
        <li ng-repeat="(key, value) in selection.selected">
          {{value.date | date:'dd-MMM-yy (EEE)':'UTC'}}
        </li>
      </ul>
    </div>

    <div class="flex-grow overflow-scroll">
      <h3 ng-if="!disp.trip.id">Stops</h3>
      <h3 ng-if="disp.trip.id">Editing trips
      </h3>

      <div class="flex-row form-inline">
        <div class="flex-grow">
          <label>
            Telephone number of driver:
            +65 <input type="tel" class="form-control" ng-model="disp.trip.driverTelephone" />

            <span ng-if="disp.trip.driverName">
              ~{{disp.driver.name}}
            </span>
          </label>

          <label>
            Trip capacity: <input type="number" class="form-control" ng-model="disp.trip.capacity" />
          </label>

          <label>
            Trip price: <input type="number" class="form-control" step="0.01" ng-model="disp.trip.price" />
          </label>

          <label ng-if="adminService.session().role == 'superadmin'">
            Company:
            <company-selector class="form-control" ng-model="disp.trip.transportCompanyId">
            </company-selector>
          </label>
        </div>
        <div class="flex-grow">
          {{disp.trip.bookingInfo}}
          <label>
            Booking Window Type:
            <select class="form-control" ng-model="disp.trip.bookingInfo.windowType">
              <option value="stop">Stop</option>
              <option value="firstStop">First stop</option>
            </select>
          </label>
          <label>
            Close booking:
            <select class="form-control" ng-model="disp.trip.bookingInfo.windowSize"
              ng-options="opt.size as opt.label for opt in disp.windowSizeOptions">
            </select>
          </label>
          <label>
            Notes to passenger:
            <input type="text" class="form-control" ng-model="disp.trip.bookingInfo.notes">
          </label>
        </div>
      </div>

      <table>
        <thead>
          <tr>
            <th>Time</th>
            <th>Stop</th>
          </tr>
        </thead>
        <tbody>
          <tr ng-repeat="tripStop in disp.trip.tripStops">
            <td>
              <uib-timepicker ng-model="tripStop.time"
              show-spinners="false" show-meridian="false">
              </uib-timepicker>
            </td>
            <td class="form-inline">
              <!-- <input type="text" ng-model="tripStop.stopId"> -->
              <stop-selector class="form-control" ng-model="tripStop.stopId"
              ></stop-selector>
              <button ng-click="showPopupFor(tripStop)" class="btn btn-default">
                ?
              </button>
            </td>
            <td>
              <label>
                <input type="checkbox" ng-model="tripStop.canBoard" />
                Boarding
              </label>
            </td>
            <td>
              <label>
                <input type="checkbox" ng-model="tripStop.canAlight" />
                Alighting
              </label>
            </td>
            <td>
              <button class="btn btn-default glyphicon glyphicon-trash"
                ng-click="disp.deleteTripStop($index)"
              ></button>
            </td>
          </tr>
        </tbody>
        <tfoot>
          <tr>
            <td>
              <button class="btn btn-default glyphicon glyphicon-plus"
                ng-click="disp.addTripStop()"
              ></button>
            </td>
          </tr>
        </tfoot>
      </table>
    </div>
  </div> <!-- row -->

  <span class="btn-group">
    <button class="btn btn-primary" ng-click="saveTrips()"
      >
      Save
    </button>
    <button class="btn btn-default" ng-click="clearEdit()"
      ng-if="disp.trip">
      Clear
    </button>
  </span>
</section>

<div>
  <table class="table table-striped">
    <thead>
      <tr>
        <th></th> <!-- selection button -->
        <th></th> <!-- actions (delete, use) -->
        <th></th> <!-- pax -->
        <th></th> <!-- booked -->
        <th></th> <!-- price -->
        <th></th> <!--date -->
        <th></th> <!-- driver -->
        <th colspan="{{disp.stopsList.length}}">Stops</th>
      </tr>
      <tr>
        <th></th>
        <th></th>
        <th>Cap</th>
        <th>Booked</th>
        <th>Price</th>
        <th>Date</th>
        <th>Driver</th>
        <th ng-repeat="stop in disp.stopsList track by $index"
            title="{{stop.stop.description}}">
          {{stop.stop.label}} /
          {{stop.stop.postcode}}
        </th>
      </tr>
    </thead>
    <tbody>
      <tr ng-repeat="trip in (sorted_trips = trips | orderBy:'date') track by trip.id"
        class="{
          active: selection.selected[trip.id]
        }"
      >
        <td
          ng-mousedown="selectTrips(sorted_trips, $index, $event)"
          >
          <small>{{trip.id}}</small>
          <i ng-hide="!selection.selected[trip.id]"
            class="glyphicon glyphicon-ok">
          </i>
        </td>
        <td>
          <span class="btn-group">
            <button class="btn btn-default glyphicon glyphicon-copy"
              ng-click='referenceTrip(trip)'
            >
            </button>
            <button class="btn btn-default glyphicon glyphicon-trash"
              ng-click='deleteTrip(trip)'
            >
            </button>
          </span>
        </td>
        <td>
          {{trip.capacity}}
          <i class="glyphicon glyphicon-user"></i>
        </td>
        <td>
          <a ui-sref="bookings({tripId: trip.id})">
            {{trip.availability.seatsBooked}}
            <i class="glyphicon glyphicon-user"></i>
          </a>
        </td>
        <td>
          {{trip.price | number:2}}
        </td>
        <td>
          {{trip.date | date:'dd/MM/yy EEE'}}
        </td>
        <td>
          {{trip.driverTelephone }}
        </td>
        <td ng-repeat="stop in disp.stopsList">
          {{ findStop(trip, stop.stop.id).time | date:'HH:mm'}}
        </td>
      </tr>
    </tbody>
  </table>
</div>
